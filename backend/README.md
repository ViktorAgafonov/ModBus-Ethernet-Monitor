# ModBusEtherMon - Backend

## Серверная часть универсального монитора ModBus по Ethernet

Данный модуль представляет собой серверную часть системы ModBusEtherMon, которая обеспечивает взаимодействие с устройствами по протоколу ModBus TCP/IP, сбор и архивацию данных, а также предоставляет API для клиентской части.

### Основные компоненты

- **ModBus клиент** - модуль для взаимодействия с устройствами по протоколу ModBus TCP/IP
- **API сервер** - RESTful API для взаимодействия с клиентской частью
- **Система авторизации** - управление пользователями и правами доступа
- **Система архивации** - сохранение данных в JSON-файлы и создание ZIP-архивов

### Структура проекта

```
backend/
├── src/                # Исходный код
│   ├── modbus/         # Модуль работы с ModBus
│   │   ├── modbus-client.js  # Клиент ModBus
│   │   └── router.js         # API роутер для ModBus
│   ├── api/            # RESTful API
│   │   └── router.js         # Основной API роутер
│   ├── auth/           # Авторизация
│   │   ├── middleware.js     # Middleware авторизации
│   │   └── router.js         # API роутер для авторизации
│   ├── config/         # Конфигурации
│   │   └── logger.js         # Настройка логирования
│   └── index.js        # Точка входа приложения
├── public/             # Публичные файлы для веб-сервера
└── package.json        # Зависимости и скрипты
```

### Требования

- Node.js v16 или выше
- npm или yarn

### Установка

1. Установить зависимости:
   ```
   npm install
   ```

2. Создать файл `.env` в корневой директории backend с следующими параметрами:
   ```
   PORT=3000
   JWT_SECRET=your-secret-key
   LOG_LEVEL=info
   ```

### Запуск

1. Запуск в режиме разработки:
   ```
   npm run dev
   ```

2. Запуск в производственном режиме:
   ```
   npm start
   ```

### API

#### Авторизация

- `POST /api/auth/login` - Вход в систему
- `POST /api/auth/register` - Регистрация нового пользователя (только для администраторов)
- `GET /api/auth/users` - Получение списка пользователей (только для администраторов)
- `GET /api/auth/users/:id` - Получение информации о пользователе
- `PUT /api/auth/users/:id` - Обновление информации о пользователе
- `DELETE /api/auth/users/:id` - Удаление пользователя (только для администраторов)
- `GET /api/auth/me` - Получение информации о текущем пользователе
- `POST /api/auth/change-password` - Изменение пароля

#### ModBus

- `GET /api/modbus/devices` - Получение списка устройств
- `GET /api/modbus/devices/:id` - Получение информации об устройстве
- `GET /api/modbus/data` - Получение данных всех устройств
- `GET /api/modbus/data/:deviceId` - Получение данных конкретного устройства
- `POST /api/modbus/connect` - Подключение к устройству
- `POST /api/modbus/disconnect` - Отключение от устройства
- `POST /api/modbus/read` - Чтение данных из регистров
- `POST /api/modbus/write` - Запись данных в регистры
- `POST /api/modbus/polling/start` - Запуск периодического опроса устройства
- `POST /api/modbus/polling/stop` - Остановка периодического опроса устройства

#### Архивы и отчеты

- `GET /api/archives` - Получение списка доступных архивов
- `GET /api/archives/:date` - Получение архива за конкретную дату
- `GET /api/archives/zip/:month` - Получение ZIP-архива за месяц
- `POST /api/archives/create-zip/:month` - Создание ZIP-архива за месяц
- `GET /api/reports/excel/:date` - Генерация Excel-отчета за указанную дату

#### Конфигурация

- `GET /api/config/:type` - Получение конфигурации указанного типа
- `PUT /api/config/:type` - Обновление конфигурации указанного типа (только для администраторов)

### Логирование

Система использует библиотеку Winston для логирования. Логи сохраняются в директории `logs/`:

- `combined.log` - все логи
- `error.log` - только ошибки

### Система авторизации

В системе предусмотрены следующие роли пользователей:

- **admin** - Администратор с полным доступом ко всем функциям
- **user** - Обычный пользователь с ограниченным доступом

При первом запуске системы необходимо создать файл конфигурации администратора в `configs/admin.config.json`. Пример:
```json
{
  "username": "admin",
  "password": "$2b$10$...", // хэш пароля
  "role": "admin"
}
```
Новые пользователи регистрируются через веб-интерфейс и ожидают подтверждения администратора.

### Журнал ошибок и статистика

Система включает в себя модуль статистики (`stats.js`), который собирает информацию о работе устройств, включая количество опросов, ошибок и время последнего успешного опроса.
