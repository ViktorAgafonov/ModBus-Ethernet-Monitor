# ModBusEtherMon

## Универсальный Монитор ModBus по Ethernet на Node.js

ModBusEtherMon - это система для мониторинга и сбора данных с устройств, поддерживающих протокол ModBus TCP/IP. Система позволяет настраивать подключение к различным устройствам, опрашивать их в автоматическом режиме, сохранять полученные данные в архивы и генерировать отчеты.

### Основные возможности

- Подключение к устройствам по протоколу ModBus TCP/IP
- Настройка параметров опроса устройств
- Автоматический сбор данных по расписанию
- Архивация данных в JSON-файлы
- Создание ZIP-архивов за месяц
- Генерация отчетов в формате Excel
- Веб-интерфейс для мониторинга и управления
- Система авторизации с разграничением прав доступа
- Журнал ошибок и статистика работы устройств
- Мониторинг состояния подключения устройств

### Структура проекта

```
ModBusEtherMon/
├── backend/                # Серверная часть
│   ├── src/                # Исходный код
│   │   ├── modbus/         # Модуль работы с ModBus
│   │   ├── api/            # RESTful API
│   │   ├── auth/           # Авторизация
│   │   └── config/         # Конфигурации
│   ├── public/             # Публичные файлы для веб-сервера
│   └── package.json        # Зависимости и скрипты
├── frontend/               # Клиентская часть
│   ├── src/                # Исходный код
│   ├── public/             # Статические файлы
│   └── index.html          # Главный HTML-файл
├── archives/               # Архивы данных
│   ├── YYYY-MM-DD.json     # Дневные JSON-архивы
│   └── Zip/                # Месячные ZIP-архивы
├── configs/                # Конфигурационные файлы
│   ├── devices.json        # Настройки ModBus-устройств
│   ├── schedule.json       # Периодичность опроса
│   └── permissions.json    # Права доступа пользователей
└── logs/                   # Логи
```

### Требования

- Node.js v16 или выше

### Установка

1. Клонировать репозиторий:
   ```
   git clone https://github.com/ViktorAgafonov/ModBus-Ethernet-Monitor.git
   cd ModBusEtherMon
   ```

2. Установить зависимости:
   ```
   npm install
   ```

3. Настроить конфигурацию устройств в файле `configs/devices.json`
   ```json
   [
     {
       "id": "device1",
       "name": "Устройство 1",
       "ip": "192.168.1.100",
       "port": 502,
       "unitId": 1,
       "enabled": true,
       "registers": [
         {
           "name": "Температура",
           "type": "holding",
           "address": 100,
           "length": 1,
           "dataType": "int16",
           "unit": "°C"
         }
       ]
     }
   ]
   ```

4. Создать файл конфигурации пользователей `configs/admin.json`
   ```json
   {
     "username": "admin",
     "password": "$2b$10$...",
     "role": "admin"
   }
   ```

5. Создать директории для архивов и логов:
   ```
   mkdir -p archives/Zip logs
   ```

### Запуск

1. Запуск системы:
   ```
   npm start
   ```

2. Открыть в браузере:
   ```
   http://localhost:3000
   ```

3. Для разработки можно запустить с автоматической перезагрузкой:
   ```
   npm run dev
   ```

### API

Основные эндпоинты API:

- `/api/auth` - Авторизация и управление пользователями
  - `POST /api/auth/login` - Вход в систему
  - `POST /api/auth/register` - Регистрация нового пользователя
  - `GET /api/auth/me` - Информация о текущем пользователе
  - `GET /api/auth/users` - Список пользователей (только для админов)
  - `GET /api/auth/pending` - Список ожидающих подтверждения пользователей
  - `POST /api/auth/approve/:userId` - Подтверждение пользователя
  - `POST /api/auth/reject/:userId` - Отклонение пользователя

- `/api/modbus` - Работа с ModBus устройствами
  - `GET /api/modbus/devices` - Список устройств
  - `GET /api/modbus/devices/:id` - Информация об устройстве
  - `GET /api/modbus/data` - Данные всех устройств
  - `GET /api/modbus/data/:deviceId` - Данные конкретного устройства
  - `POST /api/modbus/connect` - Подключение к устройству
  - `POST /api/modbus/disconnect` - Отключение от устройства
  - `POST /api/modbus/read` - Чтение данных из регистров
  - `POST /api/modbus/write` - Запись данных в регистры

- `/api/modbus/stats` - Статистика работы
  - `GET /api/modbus/stats` - Общая статистика
  - `GET /api/modbus/stats/hourly` - Почасовая статистика
  - `GET /api/modbus/stats/device/:deviceId` - Статистика устройства
  - `POST /api/modbus/stats/reset` - Сброс статистики (только для админов)

- `/api/archives` - Доступ к архивам данных
  - `GET /api/archives/list` - Список доступных архивов
  - `GET /api/archives/:date` - Получение архива за указанную дату

- `/api/health` - Проверка работоспособности системы

Все API-запросы (кроме `/api/health` и авторизации) требуют JWT-токен в заголовке `Authorization`.

### Система авторизации

В системе предусмотрены следующие роли пользователей:

- **admin** - Администратор с полным доступом ко всем функциям
- **user** - Обычный пользователь с ограниченным доступом

При первом запуске системы необходимо создать пользователя с правами администратора через веб-интерфейс. Новые пользователи должны быть подтверждены администратором после регистрации.

### Журнал ошибок

Система включает в себя журнал ошибок, который доступен через веб-интерфейс. Журнал содержит информацию о всех ошибках, возникших в процессе работы системы, включая:

- Ошибки подключения к устройствам
- Ошибки чтения/записи регистров
- Ошибки авторизации
- Другие системные ошибки
- События системы

### Статистика работы

Система собирает статистику работы устройств, которая доступна через веб-интерфейс и API:

- Общее количество опросов
- Количество ошибок
- Время последнего успешного опроса
- Почасовая статистика активности

### Лицензия

[MIT](LICENSE)
